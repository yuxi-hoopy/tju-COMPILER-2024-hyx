# 语法分析-基于SLR

LR语法分析器能识别⼏乎所有能⽤上下⽂⽆关⽂法描述的程序设计语⾔的结构。 LR分析法是已知的最⼀般的⽆回溯移动归约语法分析法，而且可以和其他移动归约分析⼀样被有效地实现。

LR分析的基本思想是，在规范归约过程中，⼀⽅⾯记住已移进和 归约出的整个符号串，即记住“历史”，另⼀⽅⾯根据所⽤的产⽣ 式推测未来可能碰到的输⼊符号，即对未来进⾏“展望。

LR的本质是双栈+DFA，而`SLR`就是LR(0)+FOLLOW集。

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240501130005226.png" alt="image-20240501130005226" style="zoom:33%;" />



## 阶段任务

在做一切之前需要对齐数据结构

### 统一数据结构，三人并行撰写代码

产生式：

```cpp
struct Production {
    string left; // 产生式左部
    vector<string> right; // 产生式右部---（在grammer.txt中多个选项则用空格分隔）
};
```

项目：

```cpp
struct Item {
    int productionIndex; // 产生式的索引
    int dotPos; // 项目点的位置---统一从下标0开始
};
```

项目集规范族：

```cpp
struct State {
    int stateNumber;//状态序号
    vector<Item> items;//状态中包含的所有项目
};
```

集合类：

```cpp
unordered_set<string> nonTerminals;//非终结符
unordered_set<string> terminals;//终结符
unordered_map<string, unordered_set<string>> firstSets;//first集
unordered_map<string, unordered_set<string>> followSets;//follow集
unordered_map<string, unordered_map<string, string>> gotoTable;//goto表
unordered_map<string, unordered_map<string, string>> actionTable;//action表
```

关于goto和action表，为方便理解和使用，举2个例子↓

```cpp
// 示例的 gotoTable
    unordered_map<string, unordered_map<string, int>> gotoTable = {
        {"S0", {{"E", 1}}},
        {"S1", {{"E", 3}, {"T", 2}}},
        {"S2", {{"T", 4}, {"F", 5}}},
    };

    // 示例的 actionTable
    unordered_map<string, unordered_map<string, string>> actionTable = {
        {"S0", {{"id", "shift 3"}, {"(", "shift 4"}}},
        {"S1", {{"+", "shift 6"}, {"$", "accept"}}},
        {"S2", {{"*", "shift 7"}}},
        {"S3", {{"+", "reduce 2"}, {"*", "reduce 2"}, {")", "reduce 2"}, {"$", "reduce 2"}}},
    };
```

### ①将文法简化为A->B形式

代码实现，网上有方法，比较简单

### ②求LR(0)项目集规范族（CLOSURE+GO函数方法），得到识别活前缀的DFA

先得到项目集（对应位置加点）->项目集规范族->得到转换关系，不需要得到DFA图，知道转换关系即可

### ③对每个非终结符求FIRST集、FOLLOW集

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240501171814547.png" alt="image-20240501171814547" style="zoom: 33%;" />

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240501171644430.png" alt="image-20240501171644430" style="zoom:50%;" />

### ④根据②③判断文法是否满足SLR文法条件

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240501125618669.png" alt="image-20240501125618669" style="zoom: 50%;" />

### ⑤利用②构造ACTION表和GOTO表

如果满足SLR（应该是SLR）

![image-20240501171952108](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240501171952108.png)

### ⑥利用分析表进行移进-规约过程

## 关于①：

老师给的文法是不是LR（0）的？这部分学长的代码并没有做，我看了他们的grammer.txt，70多行，是处理过的版本（，比老师给我们的好用，老师给的文法中还存在`闭包`和`或`,比如

```txt
compUnit -> (decl | funcDef)* EOF;
```

需要进一步处理才能用LR(0) or SLR。

去除闭包和或，将产生式简化为A ->B的形式，得到grammer.txt。注意这里不能直接用往届的txt

## 关于②、③、④：先判断文法是否符合LR(0)规范

1. ### 构造LR(0)项目集规范族

   - 先构造语法G所有的项目：逐个位置加点·

   - 然后用CLOSURE和GO函数构造G'的LR(0)项目集规范族。

     【G'为拓广文法：引进⼀个不出现在G中的⾮终结符S’，并加进⼀个新产⽣式S’→S，⽽这个S’是G’的开始符号。那么我们称G’是G的拓⼴⽂法】

     构造算法如下：

     <img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240501104304245.png" alt="image-20240501104304245" style="zoom:33%;" />

     具体过程可以参考作业4：

   <img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240501105528573.png" alt="image-20240501105528573" style="zoom:50%;" />

2. ### 判断是否存在规约-规约和规约-移进冲突，不存在则LR(0)；存在则判断FOLLOW集相交情况，大概率是SLR文法了

对于每个项目集I判断。这一步需要计算FIRST集和FOLLOW集

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240501125618669.png" alt="image-20240501125618669" style="zoom: 50%;" />

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240501125832740.png" alt="image-20240501125832740" style="zoom:33%;" />

## 填写GOTO表和ACTION表---这2个表组合起来为预测分析表

`ACTION[s ,a]`规定了当前状态s面临输入符号a时应采取什么动作。 

`GOTO[s, X]`规定了状态s面对文法符号X（终结符或⾮终结符）时，下⼀个状态是什么

看看是LR还是SLR，是哪个用哪个。

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240501104001843.png" alt="image-20240501104001843" style="zoom:33%;" />![image-20240501165925581](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240501165925581.png)

## 利用预测分析表进行移进-规约过程

LR过程原理如图：如果是SLR也是这个动作，二者的不同之处体现在分析表里，对表的使用方法一样

LR分析器的运行原理和SLR分析器类似，二者的不同之处在于它们使用不同的分析表。然而，它们在使用预测分析表上的方法是相同的。

![image-20240501172305149](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240501172305149.png)

对于SLR：

![image-20240501171234770](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240501171234770.png)
